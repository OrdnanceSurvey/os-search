!function(a,b){var c={"boolean":!1,"function":!0,object:!0,number:!1,string:!1,undefined:!1},a=c[typeof window]&&window||this,d=c[typeof exports]&&exports&&!exports.nodeType&&exports,e=c[typeof module]&&module&&!module.nodeType&&module,f=(e&&e.exports===d&&d,c[typeof global]&&global);!f||f.global!==f&&f.window!==f||(a=f),"function"==typeof define&&define.amd?define(["rx","angular","exports"],function(c,d,e){return a.Rx=b(a,e,c,d),a.Rx}):"object"==typeof module&&module&&module.exports==d?module.exports=b(a,module.exports,require("rx"),require("angular")):a.Rx=b(a,{},a.Rx,a.angular)}(this,function(a,b,c,d,e){var f=c.Observable,g=f.prototype,h=f.create,i=c.Disposable.create,j=c.SingleAssignmentDisposable,k=c.CompositeDisposable,l=c.AnonymousObservable,m=c.Scheduler,n=c.helpers.noop,o=(Object.prototype.toString,Array.prototype.slice),p=d.module("rx",[]);p.factory("rx",["$window",function(a){return a.Rx||(a.Rx=c),a.Rx}]),p.factory("observeOnScope",["rx",function(a){return function(b,c,d){return a.Observable.create(function(a){function e(b,c){a.onNext({oldValue:c,newValue:b})}return b.$watch(c,e,d)})}}]),g.safeApply=function(a,b){return b=d.isFunction(b)?b:n,this["do"](function(c){a.$$phase||a.$root.$$phase?b(c):a.$apply(function(){b(c)})})},p.config(["$provide",function(a){a.decorator("$rootScope",["$delegate",function(a){return Object.defineProperties(a.constructor.prototype,{$toObservable:{value:function(a,b){var d=this;return h(function(e){function f(a,b){e.onNext({oldValue:b,newValue:a})}var g=c.Disposable.create(d.$watch(a,f,b));return d.$on("$destroy",function(){g.dispose()}),g}).publish().refCount()},enumerable:!1,configurable:!0,writable:!0},$eventToObservable:{value:function(a){var b=this;return h(function(c){function d(){c.onNext({event:arguments[0],additionalArguments:o.call(arguments,1)})}var e=i(b.$on(a,d));return b.$on("$destroy",function(){e.isDisposed||e.dispose()}),e}).publish().refCount()},enumerable:!1,configurable:!0,writable:!0},$createObservableFunction:{value:function(a,b){var c=this;return h(function(d){return c[a]=function(){b?d.onNext(b.apply(this,arguments)):1===arguments.length?d.onNext(arguments[0]):d.onNext(arguments)},function(){delete c[a]}}).publish().refCount()},enumerable:!1,configurable:!0,writable:!0},$digestObservables:{value:function(a){var b=this;return d.map(a,function(a,c){return a.digest(b,c)}).publish().refCount()},enumerable:!1,configurable:!0,writable:!0}}),a}])}]),p.run(["$parse",function(a){g.digest=function(b,c){var d=this;return new l(function(e){var f=a(c).assign,g=new j;return g.setDisposable(d.subscribe(function(a){b.$$phase?f(b,a):b.$apply(f(b,a))},e.onError.bind(e),e.onCompleted.bind(e))),b.$on("$destroy",g.dispose.bind(g)),g})}}]);c.ScopeScheduler=function(){function a(a,b){var c=this,e=new j;return d(e,c,b,a),e}function b(a,b,e){var f=this,g=c.Scheduler.normalize(b);if(0===g)return f.scheduleWithState(a,e);var h=new j,l=setTimeout(function(){d(h,f,e,a)},g);return new k(h,i(function(){clearTimeout(l)}))}function d(a,b,c,d){function e(){!a.isDisposed&&a.setDisposable(c(b,d))}b._scope.$$phase||b._scope.$root.$$phase?e():b._scope.$apply(e)}function e(a,b,c){return this.scheduleWithRelativeAndState(a,b-this.now(),c)}var f=Date.now||+new Date;return function(c){var d=new m(f,a,b,e);return d._scope=c,d}}(),c.manageScope=function(a){return function(b){var d=b;return new l(function(b){var e=new j,f=c.ScopeScheduler(a);return e.setDisposable(d.observeOn(f).subscribe(b.onNext.bind(b),b.onError.bind(b),b.onCompleted.bind(b))),a.$on("$destroy",function(){e.dispose(),delete e}),e})}};return c});var module=angular.module("os-search",["rx"]),dependencies=["observeOnScope","$http","rx"],osSearchDirective=function(a,b,c){return{templateUrl:"templates/os-search.html",scope:{options:"=osSearch"},link:function(d,e,f){d.options=d.options||{},d.options.providers=d.options.providers||[],d.searchResults={},d.searchResultsOrderedByTime=[],d.searchInProgress={},console.log(e.children.length),d.searchProviders=d.options.providers.reduce(function(a,b){return a[b.id]=b,a},{});var g=function(a,d){if("[object Object]"!==Object.prototype.toString.call(a))throw new Error("Search provider required.");var e=angular.copy(a);e.params=e.params||{},e.providerId=a.id,delete e.id;for(var f in e.params)e.params[f]=e.params[f].replace("%s",d);for(f in e.data)e.data[f]=e.data[f].replace("%s",d);return c.Observable.fromPromise(b(e))},h=a(d,"searchInput").debounce(500).map(function(a){return a.newValue}).filter(function(a){var b=a&&a.length&&a.length>2;return d.options.providers.forEach(function(a){d.searchResults[a.id]=[{name:"In progress"}],d.searchResults[a.id].providerId=a.id,d.searchResults[a.id].inProgress=!0,d.searchInProgress[a.id]=b}),b}).distinctUntilChanged();h.subscribe(function(a){d.options.providers.forEach(function(b){d.searchResults[b.id]=[],g(b,a).subscribe(function(c){console.log(c.data.length+" results for "+b.id+" '"+a+"'",c.data),d.searchInProgress[b.id]=!1,d.searchResults[b.id].inProgress=!1,c.data.received=new Date,c.data.providerId=b.id,c.data.term=a,d.searchResults[b.id]=c.data},function(c){console.log("error querying "+b.id+" ("+a+")",c),d.searchInProgress[b.id]=!1,d.searchResults[b.id]=[{error:c.data.error}],d.searchResults[b.id].inProgress=!1,d.searchResults[b.id].received=new Date,d.searchResults[b.id].term=a,d.searchResults[b.id].providerId=b.id},function(){})})}),d.$watch("searchResults",function(){d.searchResultsOrderedByTime=[];for(var a in d.searchResults)d.searchResultsOrderedByTime.push(d.searchResults[a]);d.searchResultsOrderedByTime=d.searchResultsOrderedByTime.sort(function(a,b){return a.received>b.received?1:a.received<b.received?-1:0})},!0),d.friendlyType=function(a){var b={NAMED_ROAD:"Named Road",POPULATED_PLACE:"Populated Place",ADDRESS:"Address"};return b[a]||a},d.isOneOrMoreSearchInProgress=function(){for(var a in d.searchInProgress)if(d.searchInProgress[a])return!0;return!1},d.isOneOrMoreSearchResultAvailable=function(){return d.searchResultsOrderedByTime.filter(function(a){return a.length>0&&!a.inProgress}).length>0}}}};angular.module("os-search").directive("osSearch",dependencies.concat([osSearchDirective]));